[{"type":"tab","id":"bb2c05b5.44d3f8","label":"Skelbot"},{"id":"3ab1830c.c54e7c","type":"mqtt-broker","broker":"localhost","port":"1883","clientid":""},{"id":"f182cf43.0e7d3","type":"websocket-listener","path":"/ws","wholemsg":"false"},{"id":"2e1256fc.d1edaa","type":"http in","name":"GUI","url":"/gui","method":"get","x":114.88888549804688,"y":39.888885498046875,"z":"bb2c05b5.44d3f8","wires":[["a7027094.58fd9"]]},{"id":"a7027094.58fd9","type":"template","name":"GuiHTML","field":"","template":"<!DOCTYPE html>\n<html lang=\"no\">\n\t<head>\n\t\t<link rel=\"stylesheet\" href=\"/bootstrap/css/bootstrap.min.css\">\n\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t<style>\n\t\t\t.top-buffer { margin-top:20px; }\n\t\t\t.btn-tall { margin-bottom:4px; word-wrap:break-word;  }\n\t\t</style>\n\t\t<script>\n\t\t\tfunction sendAction(action) {\n\t\t\t\tvar xmlhttp=new XMLHttpRequest();\n\n\t\t\t\txmlhttp.onreadystatechange=function() {\n\t\t\t\t\tif (xmlhttp.readyState==4 && xmlhttp.status==200) {\n\t\t\t\t\t\tvar response = JSON.parse(xmlhttp.responseText);\n\t\t\t\t\t\t//console.log(xmlhttp.responseText);\n\t\t\t\t\t\tdocument.getElementById(\"status\").innerHTML=response.content;\n\t\t\t\t    \tdocument.getElementById(\"status\").setAttribute(\"class\", response.style);\n\t\t\t\t    }\n\t\t\t\t}\n  \n\t\t\t\txmlhttp.open(\"GET\",\"/controller?action=\" + action,true);\n\t\t\t\txmlhttp.send();\n\t\t\t}\t\n\t\t\t\n\t\t\tfunction confirmBeforeSend(action) {\n\t\t\t\tif(confirm(\"Er du sikker på at du vil skur av Skelbot?\")) {\n\t\t\t\t\tsendAction(\"Shutdown\");\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t</script>\n\t</head>\n\t\n\t<body>\n\t\t<div class=\"container-fluid\">\n\t\t\t<h1>Skelbot</h1>\n\t\t\t<div id=\"status\"><br /></div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-success btn-lg btn-block\" onclick=\"sendAction('Wake')\"><br />Våkne<br /><br /></button>\n\t\t\t\t</div> \n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-success btn-lg btn-block\" onclick=\"sendAction('Greet')\"><br />Hils<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-success btn-lg btn-block\" onclick=\"sendAction('Sleep')\"><br />Sov<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-warning btn-lg btn-block\" onclick=\"sendAction('Scare')\"><br />Skrem<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-warning btn-lg btn-block\" onclick=\"sendAction('Trick')\"><br />Knask<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-warning btn-lg btn-block\" onclick=\"sendAction('Laugh')\"><br />Le<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-primary btn-lg btn-block\" onclick=\"//sendAction('Undefined')\"><br /><br /><br /></button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-primary btn-lg btn-block\" onclick=\"sendAction('Test')\"><br />Test<br /><br /></button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-xs-4\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-danger btn-lg btn-block\" onclick=\"confirmBeforeSend('Shutdown')\"><br />Av<br /><br /></button>\n\t\t\t\t</div>\n\t\t</div>\n\t</body>\n</html>\n","x":325.8888854980469,"y":48.888885498046875,"z":"bb2c05b5.44d3f8","wires":[["e29a9dc5.1d656"]]},{"id":"e29a9dc5.1d656","type":"http response","name":"EmptyResponse","x":581.8888854980469,"y":40.888885498046875,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"c0eac54e.3f1538","type":"http in","name":"Controller","url":"/controller","method":"get","x":112.88888549804688,"y":237.88888549804688,"z":"bb2c05b5.44d3f8","wires":[["d09cc296.2f634"]]},{"id":"3dd825fd.c227da","type":"switch","name":"BehaviourSwitch","property":"req.query.action","rules":[{"t":"eq","v":"Sleep"},{"t":"eq","v":"Test"},{"t":"eq","v":"Scare"},{"t":"eq","v":"Greet"},{"t":"eq","v":"Wake"},{"t":"eq","v":"Trick"},{"t":"eq","v":"Laugh"},{"t":"eq","v":"Shutdown"}],"checkall":"true","outputs":8,"x":329.8888854980469,"y":241.88890075683594,"z":"bb2c05b5.44d3f8","wires":[["a7e2b2f5.581d5"],["48a0b0d0.b75f5"],["bd6b4bc.f4294b8"],["ea5644d9.15a9b8"],["ad634d0c.529cb"],["c666b33f.39995"],["b6926c92.496d9"],["bbb83cee.4447c"]]},{"id":"8ca25412.735da8","type":"http response","name":"EmptyResponse","x":311.8888854980469,"y":363.8888854980469,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"48a0b0d0.b75f5","type":"function","name":"TestBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"100\", \"delay\":500}, \n\t{\"gesture\":\"TILT_HEAD\", \"value\":\"200\", \"delay\":500},\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"150\", \"delay\":500},\n    {\"gesture\":\"TURN_HEAD\", \"value\":\"100\", \"delay\":500}, \n\t{\"gesture\":\"TURN_HEAD\", \"value\":\"200\", \"delay\":500},\n    {\"gesture\":\"TURN_HEAD\", \"value\":\"150\", \"delay\":500},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":500}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":500},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"150\", \"delay\":500},\n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"100\", \"delay\":500}, \n\t{\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"200\", \"delay\":500},\n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"150\", \"delay\":500},\n    {\"gesture\":\"SWITCH_LIGHT\", \"value\":\"off\", \"delay\":500},\n    {\"gesture\":\"SWITCH_LIGHT\", \"value\":\"on\", \"delay\":500}, \n\t{\"gesture\":\"SWITCH_LIGHT\", \"value\":\"off\", \"delay\":500},\n    {\"gesture\":\"SWITCH_LIGHT\", \"value\":\"on\", \"delay\":500},\n    {\"gesture\":\"SPEAK\", \"value\":\"test.mp3\", \"delay\":300},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":500},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":500}, \n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":500},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":500},\n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":500},\n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":500}\n];\n\nreturn msg;","outputs":1,"x":567.888916015625,"y":170.88888549804688,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"bd6b4bc.f4294b8","type":"function","name":"ScareBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"SPEAK\", \"value\":\"boo.mp3\", \"delay\":1000}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":0},\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"200\", \"delay\":0}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"160\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"200\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"130\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"140\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"170\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"160\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"200\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"130\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"140\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"170\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"160\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"200\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"130\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"140\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"170\", \"delay\":240}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":240}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"150\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"100\", \"delay\":240}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":1000},\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"150\", \"delay\":0}\n    \n];\n\nreturn msg;","outputs":1,"x":572.888916015625,"y":211.88888549804688,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"ea5644d9.15a9b8","type":"function","name":"GreetBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"150\", \"delay\":0},\n\t{\"gesture\":\"SPEAK\", \"value\":\"hei.mp3\", \"delay\":0},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":1200}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":350}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":550}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":450}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":450}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":0}\n    \n];\n\nreturn msg;","outputs":1,"x":571.8888854980469,"y":252.88888549804688,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"a7e2b2f5.581d5","type":"function","name":"SleepBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"SPEAK\", \"value\":\"snoring.mp3\", \"delay\":0}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"150\", \"delay\":0}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":0}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"100\", \"delay\":0}, \n    {\"gesture\":\"SWITCH_LIGHT\", \"value\":\"off\", \"delay\":0}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"150\", \"delay\":0}, \n    {\"gesture\":\"TURN_HEAD\", \"value\":\"150\", \"delay\":0}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":0}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"100\", \"delay\":200}\n];\n\nreturn msg;","outputs":1,"x":572.8888854980469,"y":128.88888549804688,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"8bf85d53.7407a","type":"async","name":"IterateGestures","async":"var cummulativeDelay = 0;\n\n//Does asynchronous calls to actions with delay\nvar doDelayedAction = function(action, servo, value, speed, delay) {\n\n\tconsole.log(\"action=\" + action + \" servo=\" + servo + \" value=\" + value + \" speed=\" + speed + \" delay=\" + delay + \" cDelay=\" + cummulativeDelay);\n\t\n\t_.delay(function() {\n\t\tcb({action:action, servo:servo, value:value, speed:speed});\n\t}, cummulativeDelay);\t\t\n\n\tcummulativeDelay = cummulativeDelay + delay;\n};\n\n//GestureSwitch\n//Iterate over gesturelist to perform all actions\nfor(index = 0; index < msg.gestureList.length; index++) {\n\tvar gestureItem = msg.gestureList[index];\n\n\tvar action = \"\";\n\tvar servo = 0;\n\tvar value = gestureItem.value;\n\tvar speed = gestureItem.speed;\n\tvar delay = gestureItem.delay;\n\n\t//Set correct action and servoes\n\tswitch(gestureItem.gesture) {\n\t\tcase \"SPEAK\":\n\t\t\taction = \"PLAY_SOUND\"; \n\t\t\tbreak;\n\t\tcase \"TURN_HEAD\":\n\t\t\taction = \"MOVE_SERVO\"; servo = 0;\n\t\t\tbreak;\n\t\tcase \"TILT_HEAD\":\n\t\t\taction = \"MOVE_SERVO\"; servo = 2;\n\t\t\tbreak;\n\t\tcase \"MOVE_RIGHT_ARM\":\n\t\t\taction = \"MOVE_SERVO\"; servo = 5;\n\t\t\tbreak;\n\t\tcase \"MOVE_LEFT_ARM\":\n\t\t\taction = \"MOVE_SERVO\"; servo = 4;\n\t\t\tbreak;\n\t\tcase \"SWITCH_LIGHT\":\n\t\t\tif(value == \"on\") { value = 200; } else { value = 170; }\n\t\t\taction = \"MOVE_SERVO\"; servo = 6; \n\t\t\tbreak;\n\t\tcase \"MOVE_JAW\":\n\t\t\taction = \"MOVE_SERVO\"; servo = 1; \n\t\t\tbreak;\n\t\tcase \"SHUTDOWN\":\n\t\t\taction = \"SHUTDOWN\";\n\t\t\tbreak;\n\t}\n\n\t//Do delayed call for each action\n\tdoDelayedAction(action, servo, value, speed, delay);\n\n}\n\n//Do delayed call to set busy state false\ndoDelayedAction(\"FINISH\", 0, 0, 0, 0);\n","outputs":1,"x":856.888916015625,"y":469.8888854980469,"z":"bb2c05b5.44d3f8","wires":[["ffc75bfe.0038a8","4006b779.bff948"]]},{"id":"ffc75bfe.0038a8","type":"switch","name":"ActionSwitch","property":"action","rules":[{"t":"eq","v":"MOVE_SERVO"},{"t":"eq","v":"PLAY_SOUND"},{"t":"eq","v":"SHUTDOWN"},{"t":"eq","v":"FINISH"}],"checkall":"true","outputs":4,"x":604.888916015625,"y":610.888916015625,"z":"bb2c05b5.44d3f8","wires":[["5c99e2d.fa3661c"],["ad639bc3.529c68"],["1c9e7c17.e36184"],["61244883.9edbb8"]]},{"id":"426dcfd3.bd923","type":"debug","name":"","active":true,"console":"false","complete":"true","x":1055.8890380859375,"y":740.8889312744141,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"ad9e216f.5261e","type":"exec","command":"omxplayer","append":"msg.payload","useSpawn":true,"name":"PlaySound","x":1066.8890380859375,"y":687.8885650634766,"z":"bb2c05b5.44d3f8","wires":[[],[],[]]},{"id":"ad639bc3.529c68","type":"function","name":"PlaySound","func":"msg.payload = \"/home/pi/skelbot/mp3/\" + msg.value;\nvar debug = \"Playing sound \" + msg.payload;\nreturn [msg, debug];","outputs":"2","x":856.888916015625,"y":647.8889923095703,"z":"bb2c05b5.44d3f8","wires":[["ad9e216f.5261e"],["426dcfd3.bd923"]]},{"id":"57eba5d7.a8145c","type":"inject","name":"OnStart","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":112,"y":131,"z":"bb2c05b5.44d3f8","wires":[["fdbd448c.0242b8"]]},{"id":"ad634d0c.529cb","type":"function","name":"WakeBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"SPEAK\", \"value\":\"creepy.mp3\", \"delay\":1000}, \n    {\"gesture\":\"SWITCH_LIGHT\", \"value\":\"on\", \"delay\":2000}, \n    {\"gesture\":\"TILT_HEAD\", \"value\":\"160\", \"speed\":1, \"delay\":0}\n];\n\nreturn msg;","outputs":1,"x":574,"y":296,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"4006b779.bff948","type":"debug","name":"","active":false,"console":"false","complete":"true","x":878,"y":385,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"1c9e7c17.e36184","type":"exec","command":"sudo shutdown -h now","append":"","useSpawn":false,"name":"Shutdown","x":863.8889770507812,"y":782.7777709960938,"z":"bb2c05b5.44d3f8","wires":[["30b2239e.cf4ddc"],[],[]]},{"id":"bbb83cee.4447c","type":"function","name":"ShutdownBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"SPEAK\", \"value\":\"shutdown.mp3\", \"delay\":3000}, \n    {\"gesture\":\"SHUTDOWN\", \"value\":\"on\", \"delay\":0}\n];\n\nreturn msg;","outputs":1,"x":581.8889465332031,"y":421.3333435058594,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"30b2239e.cf4ddc","type":"debug","name":"","active":true,"console":"false","complete":"false","x":1053.8889465332031,"y":787.8889465332031,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"5c99e2d.fa3661c","type":"function","name":"MoveServo","func":"//VARIABLES\nvar fs = context.global.fs;\nvar timers = context.global.timers;\nvar stream = fs.createWriteStream('/dev/servoblaster', { flags : 'w' });\n\n//FUNCTIONS\n\n//Function for moving servo as fast as possible with linear speed\nfunction moveServoLinear(newPosition, servo) {\n\t//Write current position to servoblaster file\n\tvar text = servo + \"=\" + newPosition + \"\\n\";\n\t\n\t//debug\n\t//console.log(text);\n\t\n\t//Write to file\n\tstream.write(text);\n}\n\n//Function for moving servo step by step with nonlinear speed\nfunction moveServoNonlinear(startPos, endPos, servo, pause) {\n\tvar increment = 0;\n\n\tconsole.log(\"Moving: startPos=\" + startPos + \" ebdPos=\" + endPos+ \" servo=\" + servo + \" pause=\" + pause);\n\t\n\t//Check which way we are moving\n\tvar direction = 1;\n\tif(startPos > endPos) {\n\t\tdirection = -1;\n\t}\n\t\t\n\t//Do recursive loop with delay\n\t(function myLoop(currentPos) {\n\t\ttimers.setTimeout(function () {\n\t\n\t\t\t//Write current position to servoblaster file\n\t\t\tmoveServoLinear(currentPos, servo);\n\t\n\t\t\t//Set appropiate travel speed (increment). Slow at start and end.\n\t\t\tvar totalTravel = (endPos - startPos)*direction;\n\t\t\tvar traveledSoFar = (currentPos - startPos)*direction;\n\t\t\tvar leftToTravel = (endPos - currentPos)*direction;\n\t\t\tif(traveledSoFar / totalTravel < 0.1 || leftToTravel / totalTravel < 0.1) {\n\t\t\t\tincrement = 1;\n\t\t\t} else {\n\t\t\t\tincrement = 2;\n\t\t\t}\n\n\t\t\t//debug\n\t\t\t//console.log(\"Left to travel: \" + leftToTravel);\n\t\n\t\t\t//Update position;\n\t\t\tcurrentPos = currentPos + increment*direction;\n\t\t\t\t\t\n\t\t\t//Do recursive call to loop\n\t\t\tif((endPos - currentPos)*direction > 0) myLoop(currentPos);      \n\n\t\t\t//Set global variable servo position to new position\n\t\t\tcontext.global.servo[msg.servo] = currentPos;\t\n\n\t\t}, pause);\n\t})(startPos);\n\n}\n\n//MAIN\n\nvar position = msg.value;\n\n//Get current servo position from global vars\nvar currentServoPos = context.global.servo[msg.servo]; \n\n//Do appropriate movement according to speed (1, 2, 3)\nswitch (msg.speed) {\n\tcase 1:\n\t\tconsole.log(\"Case Speed 1\");\n\t\tmoveServoNonlinear(currentServoPos, position, msg.servo, 60);\n\t\tbreak;\n\tcase 2:\n\t\tconsole.log(\"Case Speed 2\");\n\t\tmoveServoNonlinear(currentServoPos, position, msg.servo, 30);\n\t\tbreak;\n\tdefault:\n\t\tconsole.log(\"Case Speed 3\");\n\t\t//moveServoLinear(position, msg.servo);\n\t\tmoveServoNonlinear(parseInt(position), position, msg.servo, 0);\n\t\tbreak;\n}\n\n//Remove?\nstream.on('finish', function () {\n\tconsole.log('file has been written');\n\tstream.end();\n});\n\nreturn {payload:\"Moved servo nr \" + msg.servo + \" to position \" + position};\n","outputs":1,"x":858.0000305175781,"y":597.0000305175781,"z":"bb2c05b5.44d3f8","wires":[["4dd66dfc.b22994"]]},{"id":"fdbd448c.0242b8","type":"function","name":"SetGlobalVars","func":"context.global.busy = false;\n\ncontext.global.servo = [];\n\nfor(i=0; i<7; i++) {\n\tcontext.global.servo[i] = 150;\n}\n\nreturn msg;","outputs":1,"x":335,"y":132,"z":"bb2c05b5.44d3f8","wires":[["a7e2b2f5.581d5"]]},{"id":"913936a6.6ec6c8","type":"function","name":"SpeedTestBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"speed\":1, \"delay\":5000}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"180\", \"speed\":1, \"delay\":5000},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"speed\":2, \"delay\":2000}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"180\", \"speed\":2, \"delay\":2000},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":1000}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"180\", \"delay\":1000},\n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"150\", \"delay\":1000},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"speed\":2, \"delay\":2000}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"180\", \"speed\":2, \"delay\":2000},\n];\n\nreturn msg;","outputs":1,"x":582,"y":470,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"1c58f0c1.e3a70f","type":"inject","name":"SpeedTest","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":352,"y":458,"z":"bb2c05b5.44d3f8","wires":[["913936a6.6ec6c8"]]},{"id":"4dd66dfc.b22994","type":"debug","name":"","active":true,"console":"false","complete":"false","x":1056.0000305175781,"y":596.0000305175781,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"dffd642b.200298","type":"websocket in","name":"LiveSocket","server":"f182cf43.0e7d3","x":98,"y":784.9999980926514,"z":"bb2c05b5.44d3f8","wires":[["e544d441.1abb28"]]},{"id":"1f9083ae.e06f7c","type":"debug","name":"","active":true,"console":"false","complete":"true","x":526.0000305175781,"y":784.0001201629639,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"24041adf.dbfbe6","type":"http in","name":"LiveGUI","url":"/live","method":"get","x":97,"y":730.9999980926514,"z":"bb2c05b5.44d3f8","wires":[["ca51bfbf.35ae4"]]},{"id":"ca51bfbf.35ae4","type":"template","name":"LiveGUI","field":"payload","template":"<!DOCTYPE html>\n<html lang=\"no\">\n\t<head>\n\t\t<link rel=\"stylesheet\" href=\"/bootstrap/css/bootstrap.min.css\">\n\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\n\t\t<script type=\"text/javascript\">\n\t\t\n\t\t\tvar ws;\n\t\t\tvar retries;\n\t\t\tvar lights = 0;\n\n\t\t\tfunction wsOpen()  {\n\t\t\t\tws = new WebSocket(\"ws://home.ramon.no:1880/ws\");\n\t\t\t\tconsole.log(\"WS opened.\");\n\t\t\t\tretries = 0;\n\t\t\t}\n\t\t\t\n\t\t\tfunction wsSend(servo, value) {\n\t\t\t\tvar payload = {\"servo\":servo, \"value\":value};\t\n\t\t\t\tif(ws.readyState == 1) {\n\t\t\t\t\tws.send(JSON.stringify(payload));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction wsRetryOpen(){\n\t\t\t    if (retries < 10) {\n\t\t\t    \tconsole.log(\"WS reopen. Retry \" + retries + \" of 10.\");\n\t\t\t        setTimeout(wsOpen(), 1000);            \n\t\t\t        retries++;\n\t\t\t    }\n\t\t\t}\n\t\t\t\n\t\t\tfunction switchLight() {\n\t\t\t\tvar value;\n\t\t\t\tif(lights) {\n\t\t\t\t\tvalue= 200;\n\t\t\t\t\tlights = 0;\n\t\t\t\t} else {\n\t\t\t\t\tvalue=100;\n\t\t\t\t\tlights = 1;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\twsSend(6, value);\n\t\t\t}\n\t\t\t\n\t\t\twsOpen();\n\t\t\tws.onclose = function (event) {\n\t\t\t\tconsole.log(\"WS closed.\");\n\t\t\t    wsRetryOpen();\n\t\t\t};\n\t\t\n\t\t</script>\n\t</head>\n\t<body>\n\t\t<div class=\"container-fluid\">\n\t\t\t<h1>Skelbot Live</h1>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-sm-3 text-center\">\n\t\t\t\t\t<input class=\"bar\" type=\"range\" min=\"100\" max=\"200\" onInput=\"wsSend(2, this.value)\" style=\"-webkit-appearance: slider-vertical\">Nikke</input>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-sm-3 text-center\">\n\t\t\t\t\t<input type=\"range\" min=\"100\" max=\"200\" onInput=\"wsSend(1, this.value)\" style=\"-webkit-appearance: slider-vertical\">Kjeve</input>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-sm-7 text-center\">\n\t\t\t\t\t<input type=\"range\" min=\"100\" max=\"200\" onInput=\"wsSend(0, this.value)\">Vri hode</input>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-sm-3 text-center\">\n\t\t\t\t\t<input type=\"range\" min=\"100\" max=\"200\" onInput=\"wsSend(5, this.value)\" style=\"-webkit-appearance: slider-vertical\">Høyre arm</input>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"col-sm-3 text-center\">\n\t\t\t\t\t<input type=\"range\" min=\"100\" max=\"200\" onInput=\"wsSend(4, this.value)\" style=\"-webkit-appearance: slider-vertical\">Venstre arm</input>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"row top-buffer\">\n\t\t\t\t<div class=\"col-sm-7 text-center\">\n\t\t\t\t\t<input class=\"button\" type=\"button\" onClick=\"switchLight()\" value=\"Lys av/på\" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</body>\n</html>","x":306,"y":727.0000610351562,"z":"bb2c05b5.44d3f8","wires":[["29bb247f.d644dc"]]},{"id":"29bb247f.d644dc","type":"http response","name":"EmtpyResponse","x":526.0000305175781,"y":729.9999980926514,"z":"bb2c05b5.44d3f8","wires":[]},{"id":"e544d441.1abb28","type":"function","name":"LiveWriter","func":"var fs = context.global.fs;\nvar timers = context.global.timers;\nvar stream = fs.createWriteStream('/dev/servoblaster', { flags : 'w' });\n\n//FUNCTIONS\n\n//Function for moving servo as fast as possible with linear speed\nfunction moveServoLinear(newPosition, servo) {\n\t//Write current position to servoblaster file\n\tvar text = servo + \"=\" + newPosition + \"\\n\";\n\t\n\t//debug\n\tconsole.log(text);\n\t\n\t//Write to file\n\tstream.write(text);\n}\n\n//MAIN\nvar myPayload = JSON.parse(msg.payload);\nmoveServoLinear(myPayload.value, myPayload.servo);\n\nreturn myPayload;","outputs":1,"x":308,"y":785.9999980926514,"z":"bb2c05b5.44d3f8","wires":[["1f9083ae.e06f7c"]]},{"id":"c666b33f.39995","type":"function","name":"TrickBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"150\", \"delay\":0},\n\t{\"gesture\":\"SPEAK\", \"value\":\"knaskellerknep.mp3\", \"delay\":0},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":1000}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"130\", \"delay\":100}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":450}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":350}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":450}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":2000},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":0}\n];\n\nreturn msg;","outputs":1,"x":571.8889465332031,"y":337.888916015625,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"b6926c92.496d9","type":"function","name":"LaughBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"150\", \"delay\":0},\n\t{\"gesture\":\"SPEAK\", \"value\":\"moahahaha.mp3\", \"delay\":0},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":1000}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":250}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"170\", \"delay\":0},\n   \t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"170\", \"delay\":100}, \n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"130\", \"delay\":100}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"160\", \"delay\":50},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":150}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":150}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"170\", \"delay\":50},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":150}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":150}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"160\", \"delay\":50},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":150}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":150}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"170\", \"delay\":50},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":550}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"150\", \"delay\":150}, \n    {\"gesture\":\"TILT_HEAD\", \"value\": \"160\", \"delay\":50},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":150}, \n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":200},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":0},\n    {\"gesture\":\"MOVE_LEFT_ARM\", \"value\":\"100\", \"delay\":0}\n];\n\nreturn msg;","outputs":1,"x":575,"y":378,"z":"bb2c05b5.44d3f8","wires":[["8bf85d53.7407a"]]},{"id":"40ae2c4d.bf51d4","type":"template","name":"Return status","field":"payload","template":"{\"content\":\"{{payload.content}}\", \"style\":\"{{payload.style}}\"}","x":127,"y":363,"z":"bb2c05b5.44d3f8","wires":[["8ca25412.735da8"]]},{"id":"d09cc296.2f634","type":"function","name":"CheckBusyState","func":"if(context.global.busy) {\n\tmsg.payload.content = \"Vent! Skelbot er opptatt!\";\n\tmsg.payload.style = \"alert alert-warning\";\n\tmsg.req.query.action = \"none\";\n}  else {\n\tmsg.payload.content = \"Utfører oppførsel! (\" + msg.req.query.action + \")\";\n\tmsg.payload.style = \"alert alert-success\";\n\tcontext.global.busy = true;\n}\n\t\nreturn msg;","outputs":1,"x":130,"y":296,"z":"bb2c05b5.44d3f8","wires":[["40ae2c4d.bf51d4","3dd825fd.c227da"]]},{"id":"61244883.9edbb8","type":"function","name":"Set busy state false","func":"context.global.busy = false;\nreturn msg;","outputs":1,"x":862,"y":851,"z":"bb2c05b5.44d3f8","wires":[["4cedb7f.fb31248"]]},{"id":"4cedb7f.fb31248","type":"debug","name":"","active":true,"console":"false","complete":"false","x":1046,"y":852,"z":"bb2c05b5.44d3f8","wires":[]}]