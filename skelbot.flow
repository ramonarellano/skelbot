[{"type":"tab","id":"c4faaf4c.3b055","label":"Skelbot"},{"id":"3ab1830c.c54e7c","type":"mqtt-broker","broker":"localhost","port":"1883","clientid":""},{"id":"1a87116d.e578ef","type":"http in","name":"GUI","url":"/gui","method":"get","x":110.88888549804688,"y":79.88888549804688,"z":"c4faaf4c.3b055","wires":[["b513d898.4aec28"]]},{"id":"b513d898.4aec28","type":"template","name":"GuiHTML","field":"","template":"<html>\n\t<head>\n\t\t<script>\n\t\t\tfunction sendAction(action) {\n\t\t\t\tvar xmlhttp=new XMLHttpRequest();\n\t\t\t\txmlhttp.open(\"GET\",\"/controller?action=\" + action,true);\n\t\t\t\txmlhttp.send();\n\t\t\t\n\t\t\t}\t\n\t\t</script>\n\t</head>\n\t\n\t<body>\n\t\t<h1>Skelbot</h1>\n\t\t<p>\n\t\t\t<button onclick=\"sendAction('Laugh')\">Le</button> \n\t\t\t<button onclick=\"sendAction('Scare')\">Skrem</button> \n\t\t\t<button onclick=\"sendAction('Greet')\">Hils</button> \n\t\t\t<button onclick=\"sendAction('Sleep')\">Sov</button> \n\t\t</p>\t\n\t</body>\n</html>\n","x":329.8888854980469,"y":90.88888549804688,"z":"c4faaf4c.3b055","wires":[["e898602c.1767a"]]},{"id":"e898602c.1767a","type":"http response","name":"EmptyResponse","x":577.8888854980469,"y":80.88888549804688,"z":"c4faaf4c.3b055","wires":[]},{"id":"7c14ac3a.83eb54","type":"http in","name":"Controller","url":"/controller","method":"get","x":111.88888549804688,"y":274.8888854980469,"z":"c4faaf4c.3b055","wires":[["d06e7a0a.2f9188","9e460f41.61b9f"]]},{"id":"d06e7a0a.2f9188","type":"switch","name":"BehaviourSwitch","property":"req.query.action","rules":[{"t":"eq","v":"Laugh"},{"t":"eq","v":"Scare"},{"t":"eq","v":"Greet"},{"t":"eq","v":"Sleep"}],"checkall":"true","outputs":4,"x":328.8888854980469,"y":275.8888854980469,"z":"c4faaf4c.3b055","wires":[["9ca31681.635ce8"],["bae4d384.451b3"],["38100dd5.c7eff2"],["e22cf3ae.1dd31"]]},{"id":"9e460f41.61b9f","type":"http response","name":"EmptyResponse","x":326.8888854980469,"y":199.88888549804688,"z":"c4faaf4c.3b055","wires":[]},{"id":"9ca31681.635ce8","type":"function","name":"LaughBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"100\", \"delay\":1000}, \n\t{\"gesture\":\"TILT_HEAD\", \"value\":\"200\", \"delay\":500},\n    {\"gesture\":\"TILT_HEAD\", \"value\":\"150\", \"delay\":1000},\n    {\"gesture\":\"SPEAK\", \"value\": \"test.mp3\", \"delay\":0},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":300}, \n\t{\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"200\", \"delay\":300},\n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"150\", \"delay\":300},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":200},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":200}, \n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":200},\n    {\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":200},\n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"100\", \"delay\":200},\n\t{\"gesture\":\"MOVE_JAW\", \"value\":\"200\", \"delay\":200}\n];\n\nreturn msg;","outputs":1,"x":560.888916015625,"y":189.88888549804688,"z":"c4faaf4c.3b055","wires":[["f64dda2b.09b228"]]},{"id":"bae4d384.451b3","type":"function","name":"ScareBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TURN_HEAD\", \"value\":\"100\", \"delay\":\"200\"}, \n    {\"gesture\":\"MOVE_RIGHT_ARM\", \"value\":\"100\", \"delay\":\"200\"}, \n\t{\"gesture\":\"SPEAK\", \"value\":\"test.mp3\", \"delay\":\"3000\"},\n\t{\"gesture\":\"SPEAK\", \"value\":\"test.mp3\", \"delay\":\"0\"},\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"100\", \"delay\":\"200\"}\n];\n\nreturn msg;","outputs":1,"x":556.888916015625,"y":252.88888549804688,"z":"c4faaf4c.3b055","wires":[["f64dda2b.09b228"]]},{"id":"38100dd5.c7eff2","type":"function","name":"GreetBehaviour","func":"msg.gestureList = [\n    {\"gesture\":\"TURN_HEAD\", \"value\":\"200\", \"delay\":\"200\"}, \n\t{\"gesture\":\"SPEAK\", \"value\":\"test.mp3\", \"delay\":\"200\"},\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"100\", \"delay\":\"200\"}\n];\n\nreturn msg;","outputs":1,"x":560.8888854980469,"y":311.8888854980469,"z":"c4faaf4c.3b055","wires":[["f64dda2b.09b228"]]},{"id":"e22cf3ae.1dd31","type":"function","name":"SleepBehaviour","func":"msg.actionList = [\n    {\"gesture\":\"TURN_HEAD\", \"value\":\"200\", \"delay\":\"200\"}, \n\t{\"gesture\":\"SPEAK\", \"value\":\"test.mp3\", \"delay\":\"200\"},\n    {\"gesture\":\"TILT_HEAD\", \"value\": \"100\", \"delay\":\"200\"}\n];\n\nreturn msg;","outputs":1,"x":561.8888854980469,"y":379.8888854980469,"z":"c4faaf4c.3b055","wires":[["f64dda2b.09b228"]]},{"id":"f64dda2b.09b228","type":"async","name":"IterateGestures","async":"var cummulativeDelay = 0;\n\n//Does asynchronous calls to actions with delay\nvar doDelayedAction = function(action, servo, value, delay) {\n\n\tcummulativeDelay = cummulativeDelay + delay;\n\tconsole.log(\"action=\" + action + \" servo=\" + servo + \" value=\" + value + \" delay=\" + delay + \" cDelay=\" + cummulativeDelay);\n\t\n\t_.delay(function() {\n\t\tcb({action:action, servo:servo, value:value});\n\t}, cummulativeDelay);\t\t\n};\n\n//GestureSwitch\n//Iterate over gesturelist to perform all actions\nfor(index = 0; index < msg.gestureList.length; index++) {\n\tvar gestureItem = msg.gestureList[index];\n\n\n\tswitch(gestureItem.gesture) {\n\t\tcase \"SPEAK\":\n\t\t\tdoDelayedAction(\"PLAY_SOUND\", \"\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"TURN_HEAD\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"0\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"TILT_HEAD\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"2\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"MOVE_RIGHT_ARM\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"5\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"MOVE_LEFT_ARM\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"4\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"SWITCH_LIGHT\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"6\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t\tcase \"MOVE_JAW\":\n\t\t\tdoDelayedAction(\"MOVE_SERVO\", \"1\", gestureItem.value, gestureItem.delay);\n\t\t\tbreak;\n\t}\n}\n\n","outputs":1,"x":821.8889465332031,"y":375.8888854980469,"z":"c4faaf4c.3b055","wires":[["ed3c3518.12c3c8","c350ea91.3caf18"]]},{"id":"ed3c3518.12c3c8","type":"switch","name":"ActionSwitch","property":"action","rules":[{"t":"eq","v":"MOVE_SERVO"},{"t":"eq","v":"PLAY_SOUND"}],"checkall":"true","outputs":2,"x":316.8888854980469,"y":591.888916015625,"z":"c4faaf4c.3b055","wires":[["3302da5a.ccfd26"],["f66bd498.099428"]]},{"id":"cc68c1ea.33974","type":"debug","name":"","active":true,"console":"false","complete":"true","x":769.8889770507812,"y":705.8889465332031,"z":"c4faaf4c.3b055","wires":[]},{"id":"8d8d46ed.7272b8","type":"exec","command":"omxplayer","append":"\"/home/pi/skelbot/mp3/test.mp3\"","useSpawn":true,"name":"PlaySound","x":778.8889770507812,"y":657.8885803222656,"z":"c4faaf4c.3b055","wires":[[],[],[]]},{"id":"f66bd498.099428","type":"function","name":"PlaySound","func":"msg.payload = \"/home/pi/skelbot/mp3/\" + msg.value;\nvar debug = \"Playing sound \" + msg.value;\nreturn [msg, debug];","outputs":"2","x":562.8888244628906,"y":701.8890075683594,"z":"c4faaf4c.3b055","wires":[["8d8d46ed.7272b8"],["cc68c1ea.33974"]]},{"id":"3302da5a.ccfd26","type":"function","name":"MoveServo","func":"msg.payload = msg.servo + \"=\" + msg.value + \"\\n\";\nvar debug = \"Moving servo nr\" + msg.servo + \" to position \" + msg.value;\n\nreturn [msg, debug];","outputs":"2","x":563.8889465332031,"y":559.8889465332031,"z":"c4faaf4c.3b055","wires":[["a25048f2.5dafb8"],["2677a6d6.d9885a"]]},{"id":"2677a6d6.d9885a","type":"debug","name":"","active":true,"console":"false","complete":"true","x":765.8890380859375,"y":599.5553588867188,"z":"c4faaf4c.3b055","wires":[]},{"id":"a25048f2.5dafb8","type":"file","name":"FileWriter","filename":"/dev/servoblaster","appendNewline":false,"overwriteFile":false,"x":773.0002136230469,"y":552.6664428710938,"z":"c4faaf4c.3b055","wires":[]},{"id":"c350ea91.3caf18","type":"debug","name":"","active":true,"console":"false","complete":"true","x":902,"y":289,"z":"c4faaf4c.3b055","wires":[]}]